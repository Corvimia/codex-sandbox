IMAGE_BASE=codex-sandbox
BASE_IMAGE=codex-sandbox-base:latest
IMAGE=$(IMAGE_BASE):$(CTX)
VOLUME=codex-repos-$(CTX)
CODEX_CONFIG_DIR=$(CURDIR)/volumes/codex-config
SSH_CONFIG_DIR=$(CURDIR)/volumes/sshconfig
GIT_CONFIG_DIR=$(CURDIR)/volumes/gitconfig
GH_CONFIG_DIR=$(CURDIR)/volumes/ghconfig
WORKSPACES_DIR=$(CURDIR)/volumes/workspaces/$(CTX)
ORG?=$(CODEX_ORG)
REPO?=$(word 2,$(MAKECMDGOALS))
REPOS?=$(wordlist 2,$(words $(MAKECMDGOALS)),$(MAKECMDGOALS))
LOCAL_REPO?=$(word 2,$(MAKECMDGOALS))
LOCAL_EXTRA_REPOS?=$(wordlist 3,$(words $(MAKECMDGOALS)),$(MAKECMDGOALS))
MAIN_REPO?=$(word 1,$(REPOS))
ADD_DIR_FLAGS=$(foreach repo,$(wordlist 2,$(words $(REPOS)),$(REPOS)),--add-dir /workspace/$(repo))
RUN_CMD?=$(filter-out run,$(MAKECMDGOALS))
HOST_REPO?=$(LOCAL_REPO)
HOST_REPO_EXPANDED?=$(shell echo $(HOST_REPO))
HOST_REPO_NAME?=$(notdir $(HOST_REPO_EXPANDED))
HOST_REPO_MOUNT?=-v $(HOST_REPO_EXPANDED):/workspace/$(HOST_REPO_NAME)
HOST_REPO_WORKDIR?=/workspace/$(HOST_REPO_NAME)
EXTRA_REPOS?=$(LOCAL_EXTRA_REPOS)
EXTRA_DIR_FLAGS=$(foreach repo,$(EXTRA_REPOS),--add-dir /workspace/$(repo))

.PHONY: check-ctx check-org setup build-base build build-no-cache upgrade-tools run codex clone clean codex-clean codex-clean-all volume-fix-perms
.PHONY: $(LOCAL_REPO) $(LOCAL_EXTRA_REPOS)

$(LOCAL_REPO) $(LOCAL_EXTRA_REPOS):
	@:

check-ctx:
	@if [ -z "$(CTX)" ]; then \
	  echo "Missing required env var: CTX"; \
	  echo "Available contexts: $(CONTEXTS)"; \
	  exit 1; \
	fi
	@if [ -z "$(CONTEXT_DOCKERFILE)" ]; then \
	  echo "Context $(CTX) is missing a Makefile include or CONTEXT_DOCKERFILE"; \
	  exit 1; \
	fi
	@if [ -z "$(TOOLS_DIR)" ]; then \
	  echo "Context $(CTX) is missing TOOLS_DIR"; \
	  exit 1; \
	fi

check-org:
	@if [ -z "$(CODEX_ORG)" ]; then \
	  echo "Missing required env var: CODEX_ORG"; \
	  exit 1; \
	fi

setup: check-ctx
	./scripts/setup.sh

build-base:
	docker build $(if $(NO_CACHE),--no-cache,) -t $(BASE_IMAGE) -f common/Dockerfile.base .

build: check-ctx
	$(MAKE) build-base
	docker build $(if $(NO_CACHE),--no-cache,) -t $(IMAGE) -f $(CONTEXT_DOCKERFILE) --build-arg BASE_IMAGE=$(BASE_IMAGE) .

build-no-cache: check-ctx
	$(MAKE) build NO_CACHE=1

upgrade-tools: check-ctx
	docker run --rm \
	  -v $(TOOLS_DIR):/opt/tools \
	  -w /opt/tools \
	  $(TOOLS_UPDATE_IMAGE) sh -c '\
	    $(TOOLS_UPDATE_CMD) \
	  '
	$(MAKE) build

run: check-ctx
	@if [ -n "$(RUN_CMD)" ]; then \
		  docker run -it --rm \
		    -v $(VOLUME):/workspace \
		    -v $(CODEX_CONFIG_DIR):/home/sandbox/.codex \
		    -v $(SSH_CONFIG_DIR):/home/sandbox/.ssh \
		    -v $(GIT_CONFIG_DIR)/.gitconfig:/home/sandbox/.gitconfig \
		    -v $(GH_CONFIG_DIR):/home/sandbox/.config/gh \
		    $(IMAGE) -c '$(RUN_CMD)'; \
	else \
		  docker run -it --rm \
		    -v $(VOLUME):/workspace \
		    -v $(CODEX_CONFIG_DIR):/home/sandbox/.codex \
		    -v $(SSH_CONFIG_DIR):/home/sandbox/.ssh \
		    -v $(GIT_CONFIG_DIR)/.gitconfig:/home/sandbox/.gitconfig \
		    -v $(GH_CONFIG_DIR):/home/sandbox/.config/gh \
		    $(IMAGE); \
	fi

clone: check-ctx check-org
	docker run -it --rm \
	-v $(VOLUME):/workspace \
	-v $(CODEX_CONFIG_DIR):/home/sandbox/.codex \
	-v $(SSH_CONFIG_DIR):/home/sandbox/.ssh \
	-v $(GIT_CONFIG_DIR)/.gitconfig:/home/sandbox/.gitconfig \
	-v $(GH_CONFIG_DIR):/home/sandbox/.config/gh \
	$(IMAGE) -c '\
	    git clone git@github.com:$(ORG)/$(REPO).git /workspace/$(REPO) \
	  '

codex: check-ctx check-org
	@if [ -z "$(MAIN_REPO)" ]; then \
	  echo "Usage: make codex <repo1> [repo2 ...]"; \
	  exit 1; \
	fi
	@set -euo pipefail; \
	RAND_HEX="$$(printf '%04x' $$(( RANDOM % 65536 )))"; \
	SESSION_ID="$$(date +%Y%m%d-%H%M%S)-$$RAND_HEX"; \
	PROJECT_DIR="$(WORKSPACES_DIR)/$$SESSION_ID"; \
	echo "Session ID: $$SESSION_ID"; \
	echo "Project folder: $$PROJECT_DIR"; \
	mkdir -p "$$PROJECT_DIR"; \
	$(MAKE) build; \
	docker run -it --rm \
	  -v "$$PROJECT_DIR":/workspace \
	  -v $(SSH_CONFIG_DIR):/home/sandbox/.ssh \
	  -v $(GIT_CONFIG_DIR)/.gitconfig:/home/sandbox/.gitconfig \
	  -v $(GH_CONFIG_DIR):/home/sandbox/.config/gh \
	  $(IMAGE) -c '\
	    KEY_FILE="$$(ls /home/sandbox/.ssh/id_ed25519 /home/sandbox/.ssh/id_rsa /home/sandbox/.ssh/* 2>/dev/null | head -n 1)"; \
	    if [ -z "$$KEY_FILE" ]; then echo "No SSH key found in /home/sandbox/.ssh"; exit 1; fi; \
	    chmod 600 "$$KEY_FILE"; \
	    ssh-keyscan github.com >> /home/sandbox/.ssh/known_hosts; \
	    for repo in $(REPOS); do \
	      echo "Cloning $$repo..."; \
	      git clone "git@github.com:$(ORG)/$$repo.git" "/workspace/$$repo"; \
	      DEFAULT_BRANCH="$$(cd "/workspace/$$repo" && git remote show origin | sed -n "s/.*HEAD branch: //p")"; \
	      if [ -z "$$DEFAULT_BRANCH" ]; then DEFAULT_BRANCH="main"; fi; \
	      (cd "/workspace/$$repo" && git checkout "$$DEFAULT_BRANCH" && git pull --ff-only origin "$$DEFAULT_BRANCH"); \
	    done \
	  '; \
	docker run -it --rm \
	-v "$$PROJECT_DIR":/workspace \
	-v $(CODEX_CONFIG_DIR):/home/sandbox/.codex \
	-v $(SSH_CONFIG_DIR):/home/sandbox/.ssh \
	-v $(GIT_CONFIG_DIR)/.gitconfig:/home/sandbox/.gitconfig \
	-v $(GH_CONFIG_DIR):/home/sandbox/.config/gh \
	-w /workspace/$(MAIN_REPO) \
	$(IMAGE) -c '\
	    codex --profile full_access $(ADD_DIR_FLAGS) \
	  '

codex-clean: check-ctx
	@if [ -z "$(REPO)" ]; then \
	  echo "Usage: make codex-clean <session-id>"; \
	  exit 1; \
	fi
	@set -euo pipefail; \
	TARGET_DIR="$(WORKSPACES_DIR)/$(REPO)"; \
	if [ ! -d "$$TARGET_DIR" ]; then \
	  echo "Session folder not found: $$TARGET_DIR"; \
	  exit 1; \
	fi; \
	rm -rf "$$TARGET_DIR"; \
	echo "Removed $$TARGET_DIR"

codex-clean-all: check-ctx
	@set -euo pipefail; \
	BASE_DIR="$(WORKSPACES_DIR)"; \
	if [ ! -d "$$BASE_DIR" ]; then \
	  echo "Workspaces folder not found: $$BASE_DIR"; \
	  exit 1; \
	fi; \
	for dir in "$$BASE_DIR"/*; do \
	  [ -d "$$dir" ] || continue; \
	  rm -rf "$$dir"; \
	  echo "Removed $$dir"; \
	done

volume-fix-perms: check-ctx
	docker run --rm -u 0 \
	  -v $(VOLUME):/workspace \
	  $(IMAGE) -c "chown -R sandbox:sandbox /workspace"
